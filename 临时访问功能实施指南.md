# ikunKChat 临时访问功能实施指南

本文档详细说明了如何为 ikunKChat 添加临时免密访问功能，并更新界面文字。

## 功能概述

1. **临时免密访问**：通过一个特殊的URL链接，可以绕过密码验证，进入应用。这个链接的有效性由环境变量控制，可以随时启用或禁用。
2. **登录页文字更新**：在密码输入页面添加描述性文字。
3. **全局页脚**：在应用主界面添加版权信息。

## 实施步骤

### 1. 修改 `services/authService.ts`

在 `AuthService` 类中添加临时访问令牌的支持。

```typescript
// 在 AuthService 类中添加新的私有属性
private readonly TEMP_ACCESS_TOKEN_KEY = 'kchat-temp-access-token';
private readonly TEMP_ACCESS_TOKEN_PARAM = 'temp_token';

// 在 isAuthenticated() 方法中添加临时访问令牌检查
isAuthenticated(): boolean {
  // 首先检查临时访问令牌
  const tempToken = sessionStorage.getItem(this.TEMP_ACCESS_TOKEN_KEY);
  if (tempToken === 'true') {
    return true;
  }
  
  // 原有的认证逻辑保持不变
  for (const storage of this.storageStrategies) {
    try {
      const authValue = storage.getItem(this.AUTH_KEY);
      if (authValue === 'true') {
        // 检查认证状态是否过期
        const timestamp = storage.getItem(this.AUTH_TIMESTAMP_KEY);
        if (timestamp) {
          const authTime = parseInt(timestamp, 10);
          const now = Date.now();
          const expiryTime = this.AUTH_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
          
          if (now - authTime <= expiryTime) {
            return true;
          } else {
            // 认证已过期，清除过期状态
            this.clearAuthenticationForStorage(storage);
          }
        } else {
          // 没有时间戳，假设认证有效
          return true;
        }
      }
    } catch (error) {
      console.error('Failed to check authentication status:', error);
      continue;
    }
  }
  
  return false;
}

// 添加验证临时访问令牌的方法
verifyTempAccessToken(token: string): boolean {
  const envToken = (import.meta as any).env.VITE_TEMP_ACCESS_TOKEN;
  return token === envToken;
}

// 添加设置临时访问令牌的方法
setTempAccessToken(token: string): void {
  if (this.verifyTempAccessToken(token)) {
    sessionStorage.setItem(this.TEMP_ACCESS_TOKEN_KEY, 'true');
  }
}

// 添加清除临时访问令牌的方法
clearTempAccessToken(): void {
  sessionStorage.removeItem(this.TEMP_ACCESS_TOKEN_KEY);
}

// 修改 clearAuthentication() 方法，同时清除临时访问令牌
clearAuthentication(): void {
  for (const storage of this.storageStrategies) {
    try {
      this.clearAuthenticationForStorage(storage);
    } catch (error) {
      console.error('Failed to clear authentication state:', error);
    }
  }
  
  try {
    localStorage.removeItem(this.REMEMBER_ME_KEY);
    this.clearTempAccessToken();
  } catch (error) {
    console.error('Failed to clear remember me flag or temp access token:', error);
  }
}
```

### 2. 修改 `App.tsx`

在应用启动时检查URL中的临时访问令牌，并添加全局页脚。

```typescript
// 在 AppContainer 组件中添加 useEffect 钩子
useEffect(() => {
  // 检查URL中是否有临时访问令牌
  const urlParams = new URLSearchParams(window.location.search);
  const tempToken = urlParams.get('temp_token');
  
  if (tempToken) {
    // 验证临时访问令牌
    if (authService.verifyTempAccessToken(tempToken)) {
      authService.setTempAccessToken(tempToken);
      setIsAuthenticated(true);
      
      // 从URL中移除临时访问令牌参数
      const newUrl = window.location.pathname + window.location.search.replace(/[?&]temp_token=[^&]*/, '');
      window.history.replaceState({}, document.title, newUrl);
    }
  }
}, []);

// 在 AppContainer 组件的 return 语句中添加页脚
// 在 </div> 标签之前添加
<footer className="py-4 text-center text-sm text-gray-500 dark:text-gray-400">
  © 2025 ikunKChat
</footer>
```

### 3. 修改 `components/PasswordView.tsx`

在密码输入表单下方添加描述性文字。

```typescript
// 在 "记住我" 复选框之前添加描述文字
<div className="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
  ikunKChat是一个个人开发的web聊天项目, 用于学习和展示
</div>

<div className="flex items-center mt-4">
  <input
    type="checkbox"
    id="rememberMe"
    checked={rememberMe}
    onChange={(e) => setRememberMe(e.target.checked)}
    className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
  />
  <label htmlFor="rememberMe" className="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">
    记住我（30天内免登录）
  </label>
</div>
```

## 环境变量配置

在您的部署平台（如 Netlify, Vercel）上添加以下环境变量：

```
VITE_TEMP_ACCESS_TOKEN=your_secure_random_token_here
```

请将 `your_secure_random_token_here` 替换为您自己生成的安全随机字符串。

## 使用方法

1. 生成临时访问链接：
   ```
   https://your-domain.com?temp_token=your_secure_random_token_here
   ```
   请将 `your-domain.com` 替换为您的网站域名，`your_secure_random_token_here` 替换为您在环境变量中设置的值。

2. 禁用临时访问：
   - 删除或修改 `VITE_TEMP_ACCESS_TOKEN` 环境变量即可禁用所有临时访问链接。

## 安全注意事项

1. 请使用强随机字符串作为临时访问令牌。
2. 定期更换临时访问令牌。
3. 不要将临时访问令牌分享给不可信的人。
4. 临时访问令牌仅在当前浏览器会话有效，关闭浏览器后需要重新获取。

## Git 提交

完成所有修改后，请提交并推送您的更改：

```bash
git add .
git commit -m "添加临时访问功能和界面更新"
git push origin main