# KChat 应用更新指南

## 更新逻辑概述

KChat 应用具有自动更新功能，能够检测新版本并提供更新选项。更新逻辑如下：

### 1. 版本检测
- 应用启动时会自动检查 `/public/version.json` 文件
- 比较当前版本与服务器上的版本差异
- 如果发现新版本，会显示更新提示

### 2. 版本信息存储
- 当前版本信息存储在 `public/version.json` 中
- 用户已读版本保存在浏览器的 localStorage 中
- 使用 `loadLastReadVersion()` 和 `saveLastReadVersion()` 函数管理

### 3. 更新流程
1. **自动检测**：应用启动时自动检查更新
2. **更新提示**：发现新版本时显示 `UpdateNoticeModal`
3. **手动检查**：用户可通过设置中的更新选项手动检查
4. **更新执行**：用户点击"立即更新"按钮执行更新

### 4. PWA 更新机制
- 如果应用作为 PWA (Progressive Web App) 安装：
  - 尝试通过 Service Worker 更新
  - 监听 `controllerchange` 事件
  - 更新完成后自动刷新页面
  - 如果5秒内没有更新，强制刷新页面

- 如果不是 PWA 环境：
  - 直接刷新页面获取最新版本

## 更新操作指南

### 作为开发者，每次更新时您需要做什么？

#### 1. 更新 version.json 文件
```json
{
  "version": "1.1.0",  // 递增版本号
  "releaseDate": "2025-08-16",  // 更新发布日期
  "notes": {
    "zh": [
      "🤖 模型更新：所有聊天模型默认使用 Gemini-2.5-Pro。",
      "🧠 新增功能：增加了基本的角色记忆功能，您可以为每个角色自定义记忆。"
    ],
    "en": [
      "🤖 Model Update: All chat models now default to Gemini-2.5-Pro.",
      "🧠 New Feature: Added basic persona memory functionality, allowing you to add custom memories for each persona."
    ]
  }
}
```

#### 2. 构建和部署应用
```bash
# 构建生产版本
npm run build

# 部署到您的服务器
# 根据您的部署方式执行相应命令
```

#### 3. 验证更新
- 清除浏览器缓存或打开无痕窗口
- 访问应用，确认更新提示正常显示
- 测试更新功能是否正常工作

### 作为用户，如何更新应用？

#### 1. 自动更新
- 应用启动时会自动检测更新
- 如果发现新版本，会显示更新提示
- 点击"知道了"关闭提示，或点击"立即更新"执行更新

#### 2. 手动检查更新
1. 点击侧边栏中的设置按钮
2. 在设置菜单中找到"更新"选项
3. 点击"检查更新"按钮
4. 如果有新版本，点击"更新现在"按钮

#### 3. PWA 环境
- 如果应用安装为 PWA，更新会自动下载并在下次启动时应用
- 您也可以点击"立即更新"按钮立即应用更新

#### 4. 非PWA环境
- 点击"立即更新"按钮会刷新页面，获取最新版本

## 更新逻辑问题检查

经过检查，应用的更新逻辑工作正常，没有发现明显问题：

1. **版本检测**：正确比较版本号并显示更新提示
2. **存储管理**：正确管理版本信息的存储和读取
3. **PWA 支持**：正确处理 PWA 环境下的 Service Worker 更新
4. **错误处理**：包含基本的错误处理和用户反馈
5. **用户体验**：提供清晰的更新提示和操作选项

## 建议改进

虽然当前更新逻辑工作正常，但可以考虑以下改进：

1. **更新进度显示**：在下载更新时显示进度条
2. **更新失败重试**：添加自动重试机制
3. **后台更新**：对于 PWA 环境，可以在后台下载更新，减少用户等待时间
4. **更新历史**：记录更新历史，方便用户查看已安装的更新